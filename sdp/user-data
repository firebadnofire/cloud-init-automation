#cloud-config

write_files:
  - path: /etc/apt/apt.conf.d/01proxy
    owner: root:root
    permissions: '0644'
    content: |
      Acquire::http::Proxy "http://192.168.122.1:3142";
      Acquire::https::Proxy "http://192.168.122.1:3142";

  # Since Debian 13, APT has defaulted to HTTPS repositories. Since apt-cacher-ng is HTTP, we must use HTTP repositories. 
  # This config is the same config as /usr/share/doc/apt/examples/debian.sources which still points to HTTP URLs
  - path: /etc/apt/sources.list.d/debian.sources
    owner: root:root
    permissions: '0644'
    content: |
      ## Debian distribution repository
      ##
      ## The following settings can be adjusted to configure which packages to use from Debian.
      ## Mirror your choices (except for URIs and Suites) in the security section below to
      ## ensure timely security updates.
      ##
      ## Types: Append deb-src to enable the fetching of source package.
      ## URIs: A URL to the repository (you may add multiple URLs)
      ## Suites: The following additional suites can be configured
      ##   <name>-updates   - Urgent bug fix updates produced after the final release of the
      ##                      distribution.
      ##   <name>-backports - software from this repository may not have been tested as
      ##                      extensively as that contained in the main release, although it includes
      ##                      newer versions of some applications which may provide useful features.
      ##                      Also, please note that software in backports WILL NOT receive any review
      ##                      or updates from the Debian security team.
      ## Components: Aside from main, the following components can be added to the list
      ##   contrib           - Free software that may require non-free software to run.
      ##   non-free-firmware - Firmware that is non-free
      ##   non-free          - Software that is not under a free license. There may be restrictions
      ##                       on use or modification.
      ##
      ## See the sources.list(5) manual page for further settings.
      Types: deb
      URIs: http://deb.debian.org/debian
      Suites: trixie trixie-updates
      Components: main contrib non-free non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

      ## Debian security updates. Aside from URIs and Suites,
      ## this should mirror your choices in the previous section.
      Types: deb
      URIs: http://deb.debian.org/debian-security
      Suites: trixie-security
      Components: main contrib non-free non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

package_update: true
package_upgrade: true

users:
  - name: testuser
    gecos: testuser
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo

packages:
  - curl
  - bash
  - ca-certificates
  - gcc
  - binutils
  - pkg-config
  - git
  - make
  - bind9-dnsutils

runcmd:
  - mount --mkdir -o ro -L cidata /mnt/cidata
  - sudo -u testuser /mnt/cidata/golang.sh | tee /var/log/golang-install.log
  - sudo -u testuser /mnt/cidata/sdp.sh | tee /var/log/sdp.log
